#!/usr/bin/env bash
set -euo pipefail

SCRIPT_URL="https://github.com/nsg/claude-sandbox/releases/latest/download/claude-sandbox"

update_check() {
    local cache_file="${XDG_CACHE_HOME:-$HOME/.cache}/claude-sandbox-lastmod"
    mkdir -p "$(dirname "$cache_file")"

    # Get remote Last-Modified via HEAD request with redirects (skip silently if offline)
    remote_lastmod=$(curl -fsSIL "$SCRIPT_URL" 2>/dev/null | grep -i '^last-modified:' | tail -1 | tr -d '\r') || return
    local_lastmod=$(cat "$cache_file" 2>/dev/null || echo "")

    # First run: save baseline without prompting
    if [[ -z "$local_lastmod" ]]; then
        echo "$remote_lastmod" > "$cache_file"
        return
    fi

    if [[ "$remote_lastmod" != "$local_lastmod" ]]; then
        while true; do
            read -p "Update available. Update now? [y/N] " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                curl -fsSL "$SCRIPT_URL" -o "$0"
                echo "$remote_lastmod" > "$cache_file"
                exec "$0" "$@"
            elif [[ -z "$REPLY" || $REPLY =~ ^[Nn]$ ]]; then
                break
            fi
        done
    fi
}

update_check "$@"

skills_update_check() {
    local skills_url="https://github.com/nsg/claude-sandbox/releases/latest/download/skills.tar.gz"
    local cache_file="${XDG_CACHE_HOME:-$HOME/.cache}/claude-sandbox-skills-lastmod"

    # Only check if skills were previously installed
    [[ -f "$cache_file" ]] || return

    local_lastmod=$(cat "$cache_file")

    # Get remote Last-Modified via HEAD request (skip silently if offline)
    remote_lastmod=$(curl -fsSIL "$skills_url" 2>/dev/null | grep -i '^last-modified:' | tail -1 | tr -d '\r') || return

    if [[ "$remote_lastmod" != "$local_lastmod" ]]; then
        while true; do
            read -p "Skills update available. Update now? [y/N] " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                install_skills
                break
            elif [[ -z "$REPLY" || $REPLY =~ ^[Nn]$ ]]; then
                break
            fi
        done
    fi
}

IMAGE="ghcr.io/nsg/claude-sandbox:latest"

run_args=(
    --rm -it
    --pull=newer
    -v "$(pwd):/workspace"
    -v "$HOME/.claude:/root/.claude"
    -e CLAUDE_CONFIG_DIR=/root/.claude
    -e TERM=xterm-256color
    -e COLORTERM=truecolor
    -e GIT_USER_NAME="$(git config user.name)"
    -e GIT_USER_EMAIL="$(git config user.email)"
    -v /etc/localtime:/etc/localtime:ro
    -v /etc/timezone:/etc/timezone:ro
    -w /workspace
    "$IMAGE"
)

install_skills() {
    local skills_url="https://github.com/nsg/claude-sandbox/releases/latest/download/skills.tar.gz"
    local target_dir="$HOME/.claude/skills"
    local cache_file="${XDG_CACHE_HOME:-$HOME/.cache}/claude-sandbox-skills-lastmod"

    echo "Installing skills to $target_dir..."
    mkdir -p "$target_dir"
    curl -fsSL "$skills_url" | tar -xz -C "$target_dir"

    # Save the Last-Modified header for future update checks
    mkdir -p "$(dirname "$cache_file")"
    remote_lastmod=$(curl -fsSIL "$skills_url" 2>/dev/null | grep -i '^last-modified:' | tail -1 | tr -d '\r') || true
    if [[ -n "$remote_lastmod" ]]; then
        echo "$remote_lastmod" > "$cache_file"
    fi

    echo "Skills installed successfully."
}

skills_update_check

case "${1:-}" in
    shell)
        podman run "${run_args[@]}" bash -l
        ;;
    install)
        if [[ "${2:-}" == "skills" ]]; then
            install_skills
        else
            echo "Unknown install target: ${2:-}"
            echo "Usage: claude-sandbox install skills"
            exit 1
        fi
        ;;
    *)
        podman run "${run_args[@]}" bash -lc "claude $*"
        ;;
esac
