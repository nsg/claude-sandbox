name: Build and publish release

on:
  push:
    branches: ['master']

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build claude-sandbox binary
        run: |
          rustup default stable
          cd claude-sandbox && cargo build --release

      - name: Build skills archives
        run: make dist

      - name: Create or update release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete latest --yes 2>/dev/null || true
          {
            echo "Run Claude CLI in a containerized environment."
            echo ""
            echo "## Installation"
            echo ""
            echo '```bash'
            echo 'curl -fsSL https://github.com/nsg/claude-sandbox/releases/latest/download/claude-sandbox -o ~/bin/claude-sandbox'
            echo 'chmod +x ~/bin/claude-sandbox'
            echo '```'
            echo ""
            echo "## Install Skills"
            echo ""
            echo '```bash'
            echo 'claude-sandbox install skills'
            echo '```'
            echo ""
            echo "## Container Image"
            echo ""
            echo '```bash'
            echo 'podman pull ghcr.io/nsg/claude-sandbox:latest'
            echo '```'
            echo ""
            echo "## Recent Changes"
            echo ""
            echo '```'
            git log --oneline -20
            echo '```'
          } | gh release create latest --title "Latest" --notes-file - claude-sandbox/target/release/claude-sandbox dist/skills.zip dist/skills.tar.gz
